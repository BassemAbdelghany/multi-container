# ---------- Base image ----------
FROM node:20-alpine AS base
WORKDIR /app

# 1) Make absolutely sure no prior config/policy interferes
#    - remove any global npmrc
#    - clear any auth token pointed at npmjs
#    - force the public registry
#    - optional: quiet audits/funding in CI logs
RUN rm -f /root/.npmrc \
 && npm config delete //registry.npmjs.org/:_authToken || true \
 && npm config set registry=https://registry.npmjs.org/ \
 && npm config set audit=false \
 && npm config set fund=false

# 2) Copy manifests first for caching
COPY package.json package-lock.json ./

# 3) DEBUG (temporary): print npm config and try a HEAD request to the tarball
#    Remove these three lines once things are green.
RUN node -v && npm -v && npm config list \
 && apk add --no-cache curl \
 && curl -I https://registry.npmjs.org/yocto-queue/-/yocto-queue-0.1.0.tgz

# 4) Deterministic install
RUN npm ci

# 5) Now bring in sources
COPY . .

CMD ["npm", "start"]